<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Table</title>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='components_result.css') }}"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  </head>
  <body>
    <div class="table-container">
      <h1>Coordinates Calculated</h1>
      <div class="table-description">
        Coordinates calculated based on the regions.
      </div>
      <div class="table-buttons">
        <div class="btn-group">
          <button id="delete-btn" class="btn-outline">Delete</button>
          <button id="export-btn" class="btn-outline">Export</button>
          <button class="btn-primary" id="add-coordinate-btn">
            + Add Coordinate
          </button>
        </div>
      </div>
      <div id="coordinate-form" style="display: none">
        <label for="lat">Latitude: </label>
        <input type="text" id="lat" placeholder="Enter latitude" required />
        <label for="lon">Longitude: </label>
        <input type="text" id="lon" placeholder="Enter longitude" required />
        <button id="submit-coordinate" class="btn-primary">
          Add Coordinate
        </button>
        <button id="cancel-coordinate" class="btn-outline">Cancel</button>
      </div>
      <table id="example" class="display">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all" /></th>
            <th>Latitude</th>
            <th>Longitude</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer-buttons">
      <button id="continue-btn" class="btn-blue">Process data</button>
    </div>

    <script>
      $(document).ready(function () {
        var table = $("#example").DataTable({
          paging: false,
          info: false,
          ordering: true,
        });

        var lastSelectedRow = null;

        $("#select-all").on("click", function () {
          var rows = table.rows({ search: "applied" }).nodes();
          $('input[type="checkbox"]', rows).prop("checked", this.checked);
        });

        Papa.parse("/static/data/output/lat_lon_calculated.csv", {
          download: true,
          header: false,
          delimiter: ";",
          skipEmptyLines: true,
          complete: function (results) {
            var data = results.data;
            if (data.length === 0) {
              console.error("No data found");
            } else {
              data.forEach(function (row, index) {
                if (index > 0) {
                  table.row
                    .add([ 
                      '<input type="checkbox" class="row-checkbox">',
                      row[0],
                      row[1],
                    ])
                    .draw(false);
                }
              });
            }
          },
          error: function (error) {
            console.error("Error loading CSV", error);
          },
        });

        $("#delete-btn").on("click", function () {
          table.rows(".selected").remove().draw();
        });

        $("#export-btn").on("click", function () {
          var data = [];
          table.rows().every(function () {
            var rowData = this.data();
            data.push([rowData[1], rowData[2]]);
          });

          var csv = Papa.unparse(data);
          var hiddenElement = document.createElement("a");
          hiddenElement.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
          hiddenElement.target = "_blank";
          hiddenElement.download = "lat_lon_data.csv";
          hiddenElement.click();
        });

        $("#example tbody").on("click", 'input[type="checkbox"]', function (e) {
          var row = $(this).closest("tr");
          var isShiftPressed = e.shiftKey;

          if (isShiftPressed && lastSelectedRow !== null) {
            var start = table.row(lastSelectedRow).index();
            var end = table.row(row).index();
            var rows = table.rows().nodes();

            var min = Math.min(start, end);
            var max = Math.max(start, end);

            for (var i = min; i <= max; i++) {
              $('input[type="checkbox"]', rows[i]).prop("checked", true);
              $(rows[i]).addClass("selected");
            }
          } else {
            if (this.checked) {
              row.addClass("selected");
            } else {
              row.removeClass("selected");
            }
          }

          lastSelectedRow = row;
        });

        $("#add-coordinate-btn").on("click", function () {
          $("#coordinate-form").show();
        });

        $("#cancel-coordinate").on("click", function () {
          $("#coordinate-form").hide();
        });

        $("#submit-coordinate").on("click", function () {
          var lat = $("#lat").val();
          var lon = $("#lon").val();

          if (lat && lon) {
            table.row
              .add(['<input type="checkbox" class="row-checkbox">', lat, lon])
              .draw(false);

            $("#lat").val("");
            $("#lon").val("");
            $("#coordinate-form").hide();
          } else {
            alert("Please enter both latitude and longitude");
          }
        });

        $("#example thead th").on("click", function (e) {
          e.stopPropagation();
        });

        $("#continue-btn").on("click", function () {
          var data = [];
          table.rows().every(function () {
            var rowData = this.data();
            data.push([rowData[1], rowData[2]]);
          });

          $.ajax({
            url: "/update_csv",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ coordinates: data }),
            beforeSend: function () {
              alert("Processing your request, please wait...");
            },
            success: function (response) {
              alert("CSV updated and Google Places API successfully called!");

              window.location.href = "/components_result";
            },
            error: function (xhr, status, error) {
              alert("An error occurred while processing the request.");
            },
          });
        });
      });
    </script>
  </body>
</html>
