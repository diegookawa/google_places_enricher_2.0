<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrich Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='tables.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        .submit-container {
            text-align: center;
            margin-top: 20px;
        }
        .submit-container button {
            padding: 15px 30px;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="content">
            <h1>Enrich Google Places data</h1>
            <!-- TODO: Implement in the backend. -->
            <!-- Component 1: Pick existing dataset to enrich -->
            <div class="table-container">
                <div class="form-group">
                    <label for="existingDataset">Select Existing Dataset</label>
                    <select id="existingDataset" name="existingDataset" onchange="toggleUploadInput()">
                        <option value="dataset1">Dataset 1</option>
                        <option value="dataset2">Dataset 2</option>
                        <option value="upload">Upload New Dataset</option>
                        <!-- Add more options as needed -->
                    </select>
                </div>
                <div class="form-group" id="uploadDatasetGroup" style="display: none;">
                    <label for="uploadDataset">Or Upload a Dataset (CSV)</label>
                    <input type="file" id="uploadDataset" name="uploadDataset" accept=".csv">
                </div>
                <!-- TODO: Add a link back to the main page. -->
                <p>If you don't have data yet, please return to the extract data from Google Places step.</p>
            </div>

            <!-- Component 2: Table for categories -->
            <div class="table-container">
                <h2>Manage Categories</h2>
                <div class="table-buttons">
                    <div class="btn-group">
                        <button id="delete-btn" class="btn-outline">Delete</button>
                        <button id="export-btn" class="btn-outline">Export</button>
                        <button class="btn-primary" id="add-new-value-btn">+ Add Category</button>
                    </div>
                </div>
                <table id="table" class="display">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" /></th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="upload-container">
                    <form id="csv-upload-form" enctype="multipart/form-data" method="POST">
                        <input type="file" id="csv-file" name="csv-file" accept=".csv" />
                        <button type="button" class="btn-primary" id="load-btn">Load</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="submit-container">
        <button type="submit" class="btn-primary">Submit</button>
    </div>

    <script>
        var table;

        function toggleUploadInput() {
            var select = document.getElementById('existingDataset');
            var uploadGroup = document.getElementById('uploadDatasetGroup');
            if (select.value === 'upload') {
                uploadGroup.style.display = 'block';
            } else {
                uploadGroup.style.display = 'none';
            }
        }

        function loadCategories() {
            $.ajax({
                url: "/get_enrichment_categories",
                method: "GET",
                success: function (response) {
                    if (response.categories) {
                        table.clear();
                        response.categories.forEach(function (category) {
                            table.row.add(['<input type="checkbox" class="row-checkbox">', category]).draw(false);
                        });
                    }
                },
                error: function (xhr) {
                    alert("Error loading categories: " + xhr.responseText);
                },
            });
        }

        $(document).ready(function () {
            table = $("#table").DataTable({
                paging: true,
                pageLength: 12,
                lengthChange: false,
                info: false,
                ordering: true,
                dom: "ft<'row'<'col-sm-12'p>>",
            });

            loadCategories();

            $("#select-all").on("click", function () {
                var rows = table.rows({ search: "applied" }).nodes();
                $('input[type="checkbox"]', rows).prop("checked", this.checked);
            });

            $("#table tbody").on("click", 'input[type="checkbox"]', function () {
                var row = $(this).closest("tr");
                if (this.checked) {
                    row.addClass("selected");
                } else {
                    row.removeClass("selected");
                }
            });

            $("#delete-btn").on("click", function () {
                table.rows(function (idx, data, node) {
                    return $('input[type="checkbox"]', node).prop("checked");
                }).remove().draw();
            });

            $("#export-btn").on("click", function () {
                var data = [];
                table.rows().every(function () {
                    var rowData = this.data();
                    data.push([rowData[1]]);
                });
                var csv = Papa.unparse({ fields: ["Category"], data: data });
                var hiddenElement = document.createElement("a");
                hiddenElement.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                hiddenElement.target = "_blank";
                hiddenElement.download = "enrichment_categories.csv";
                hiddenElement.click();
            });

            $("#csv-upload-form").on("submit", function (event) {
                event.preventDefault();
                var data = [];
                table.rows().every(function () {
                    var rowData = this.data();
                    data.push({ category: rowData[1] });
                });
                $.ajax({
                    url: "/enrichment_categories",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ categories: data }),
                    success: function (response) {
                        alert("Data uploaded successfully.");
                    },
                    error: function (xhr) {
                        alert("Upload error: " + xhr.responseText);
                    }
                });
            });

            $("#add-new-value-btn").on("click", function () {
                var newCategory = prompt("Enter new category:");
                if (newCategory) {
                    table.row.add(['<input type="checkbox" class="row-checkbox">', newCategory]).draw(false);
                }
            });

            $("#load-btn").on("click", function () {
                var fileInput = document.getElementById("csv-file");
                var file = fileInput.files[0];
                if (file) {
                    Papa.parse(file, {
                        header: true,
                        delimiter: ";",
                        complete: function (results) {
                            var data = results.data;
                            table.clear();
                            data.forEach(function (row) {
                                table.row.add(['<input type="checkbox" class="row-checkbox">', row.category]).draw(false);
                            });
                        },
                        error: function (error) {
                            alert("Error parsing CSV file: " + error.message);
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>